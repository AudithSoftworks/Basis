language: php
php:
  - '7.0'

sudo: required

services:
  - docker

env:
  - PHP_VERSION=5
  - PHP_VERSION=7

matrix:
  fast_finish: true

# sudo: false

cache:
  directories:
    - ./node_modules
    - ./public/bower_components
    - ./vendor

before_install:
  - curl -L https://github.com/docker/compose/releases/download/1.8.0/docker-compose-`uname -s`-`uname -m` > docker-compose; chmod +x docker-compose; true
  - sudo mv docker-compose /usr/local/bin/
  - pwd && docker -v && docker info && docker-compose -v

install:
  - chmod -R 0777 ./storage/logs

  - export PR=https://api.github.com/repos/$TRAVIS_REPO_SLUG/pulls/$TRAVIS_PULL_REQUEST
  - export BRANCH=$(if [ "$TRAVIS_PULL_REQUEST" == "false" ]; then echo $TRAVIS_BRANCH; else echo `curl -s $PR | jq -r .head.ref`; fi)
  - echo "TRAVIS_BRANCH=$TRAVIS_BRANCH, PR=$PR, BRANCH=$BRANCH"

  # Docker build
  - if [[ $BRANCH == 'docker-build' ]]; then docker build -qf storage/build/scripts/nginx/Dockerfile -t audithsoftworks/basis:nginx .; fi;
  - if [[ $BRANCH == 'docker-build' && $PHP_VERSION == '5' ]]; then docker build -qf storage/build/scripts/php_5.6/Dockerfile -t audithsoftworks/basis:php_5.6 .; fi;
    if [[ $BRANCH == 'docker-build' && $PHP_VERSION == '7' ]]; then docker build -qf storage/build/scripts/php_7/Dockerfile -t audithsoftworks/basis:php_7 .; fi;
  - if [[ $BRANCH == 'docker-build' && $PHP_VERSION == '5' ]]; then docker build -qf storage/build/scripts/php_5.6-fpm/Dockerfile -t audithsoftworks/basis:php_5.6-fpm .; fi;
    if [[ $BRANCH == 'docker-build' && $PHP_VERSION == '7' ]]; then docker build -qf storage/build/scripts/php_7-fpm/Dockerfile -t audithsoftworks/basis:php_7-fpm .; fi;

  # docker-compose pull
  - if [[ $BRANCH != 'docker-build' ]]; then docker-compose pull; fi;

before_script:
  # Run build script
  - chmod +x ./storage/build/scripts/dev-env/build.sh;
  - ./storage/build/scripts/dev-env/build.sh;

script:
  # Testing against MariaDb
  - docker exec basis_php${PHP_VERSION}-cli_1 /bin/bash -c "cd /home/basis; ./vendor/bin/phpunit --debug --verbose";

  # Switching to PgSQL
  - cat .env | sed s/DB_CONNECTION=.*/DB_CONNECTION=pgsql/g | sed s/DB_HOST=.*/DB_HOST=postgres/g | sed s/DB_USERNAME=.*/DB_USERNAME=postgres/g | tee .env

  # Testing against PgSQL
  - docker exec basis_php${PHP_VERSION}-cli_1 /bin/bash -c "cd /home/basis; ./vendor/bin/phpunit --debug --verbose";

after_script:
  - wget https://scrutinizer-ci.com/ocular.phar
  - if [[ $PHP_VERSION == 5 ]]; then php ocular.phar code-coverage:upload --format=php-clover ./storage/coverage/coverage.xml; fi

notifications:
  hipchat: f504f9e2e6696c17589a7b49f4ce05@Audith.Basis
